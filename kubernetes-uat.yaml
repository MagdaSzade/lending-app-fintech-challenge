apiVersion: apps/v1
kind: Deployment
metadata:
    name: my-app
    namespace: fintech-uat-carpo-team
    labels:
        app: my-app
spec:
    replicas: 1
    selector:
        matchLabels:
            app: my-app
    template:
        metadata:
            labels:
                app: my-app
        spec:
            imagePullSecrets:
                - name: fintech-docker-secret
            containers:
                - name: my-app
                  image: carpo-team-docker-registry.fintechchallenge.pl/carpo-team/my-app:latest
                  imagePullPolicy: Always
                  env:
                      - name: API_BASE_PATH
                        value: placeholder
                  ports:
                      - name: web
                        containerPort: 8080
                        protocol: TCP
                  resources:
                      limits:
                          cpu: 5m
                          memory: 16Mi
                      requests:
                          cpu: 1m
                          memory: 4Mi
                  livenessProbe:
                      httpGet:
                          path: /
                          port: web
                      initialDelaySeconds: 10
                      periodSeconds: 10
                  readinessProbe:
                      httpGet:
                          path: /
                          port: web
                      initialDelaySeconds: 10
                      periodSeconds: 10
            restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
    name: my-app
    namespace: fintech-uat-carpo-team
    labels:
        app: my-app
        visualize: 'true'
spec:
    ports:
        - name: web
          port: 8080
          protocol: TCP
          targetPort: web
    selector:
        app: my-app
---

---
# Note: in a kubernetes secret the string (e.g. generated by htpasswd) must be base64-encoded first.
# To create an encoded user:password pair, the following command can be used:
# htpasswd -nb user password | openssl base64

apiVersion: v1
kind: Secret
metadata:
    name: fintech-uat-carpo-team-basic-auth-secret
    namespace: fintech-uat-carpo-team

data:
    users: |
        ZXhhbXBsZTokYXByMSROOG1OUFFKTiRJWTVyZnBTenJEZkszTmN1bkhTbWQvCgo=

#encryped username: example, with password: example

---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
    name: fintech-uat-carpo-team-basic-auth-middleware
    namespace: fintech-uat-carpo-team
spec:
    basicAuth:
        secret: fintech-uat-carpo-team-basic-auth-secret
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
    name: my-app
    namespace: fintech-uat-carpo-team
spec:
    entryPoints:
        - websecure
    routes:
        - kind: Rule
          match: Host(`my-app.carpo-team.uat.fintechchallenge.pl`)
          middlewares:
              - name: fintech-uat-carpo-team-basic-auth-middleware
                namespace: fintech-uat-carpo-team
          services:
              - kind: Service
                name: my-app
                namespace: fintech-uat-carpo-team
                passHostHeader: true
                port: 8080
                scheme: http
    tls:
        options:
            namespace: fintech-uat-carpo-team
        certResolver: hltech
        domains:
            - main: my-app.carpo-team.uat.fintechchallenge.pl
